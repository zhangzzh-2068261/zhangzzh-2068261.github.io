uc.players = {};

//Also used in Customizer for live previews
uc.setup_banner = function(){
    if (jQuery('#banners ul li').length > 1) {
        jQuery('#banners').bjqs({
            automatic: true,
            animtype : 'slide', //fade
            width : jQuery('#banners').width(),
            height : jQuery('#banners').height(),
            animspeed: UC_CONFIG.SLIDER_SPEED,
            hoverpause: true,
            showcontrols: true,
            showmarkers: true,
            responsive: true
        });

    }
}

jQuery(function($){
	//Re-initialize formSelect() when multi-page forms are navigated
    $(document).bind('gform_page_loaded', function(event, form_id, current_page){
		$('select:not(.browser-default)').formSelect();
    });

    if (window.uc_them_js_already_fired) return; else window.uc_them_js_already_fired = true; //Something causes .ready fires twice!! This is a hack for that

    if(typeof uc.yt_embeds !== 'undefined' && uc.yt_embeds.length > 0) {
        window.onYouTubeIframeAPIReady = function() {
            for (embed in uc.yt_embeds){
                player_id = uc.yt_embeds[embed];
                uc.players[player_id] = new YT.Player(player_id, {
                     events: {
                    }
                });

            }
        }

        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        $('.video-thumb-wrapper.inline.youtube').click(function() {
			$(this).addClass('playing');
            uc.players[$(this).attr('data-playerid')].playVideo();
            return false;
        });


    }

    if(typeof uc.vimeo_embeds !== 'undefined' && uc.vimeo_embeds.length > 0) {
        var tag = document.createElement('script');
        tag.src = "https://player.vimeo.com/api/player.js";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        $('.video-thumb-wrapper.inline.vimeo').click(function () {
            $(this).addClass('playing');
            if (typeof uc.players[$(this).attr('data-playerid')] == 'undefined') {
                uc.players[$(this).attr('data-playerid')] = new Vimeo.Player($(this).attr('data-playerid'));
            }
            uc.players[$(this).attr('data-playerid')].play();
            return false;
        });
    }

    if(typeof uc.wistia_embeds !== 'undefined' && uc.wistia_embeds.length > 0) {
		var tag = document.createElement('script');
		tag.src = "https://fast.wistia.net/assets/external/E-v1.js";
		var firstScriptTag = document.getElementsByTagName('script')[0];
		firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

		$('.video-thumb-wrapper.inline.wistia').click(function() {
			$(this).addClass('playing');
			player = Wistia.api($(this).attr('data-playerid'));
			if (typeof player != 'undefined') {
				player.play();
			}
			return false;
		});

	}

	$(".widget_search label, .widget_uc_search label").inFieldLabels();
	//$(".widget-title:not(.no-lettering), .widget-title.no-lettering .lettering").lettering('words');

	uc.setup_banner();

	// $('body').on('click', '.social-sharing a', function(event) {
	//     var width  = 575,
	//         height = 400,
	//         left   = ($(window).width()  - width)  / 2,
	//         top    = ($(window).height() - height) / 2,
	//         url    = this.href,
	//         opts   = 'status=1' +
	//                  ',width='  + width  +
	//                  ',height=' + height +
	//                  ',top='    + top    +
	//                  ',left='   + left;

	//     window.open(url, 'social-sharing', opts);
	//     return false;
	// });

	$('body').append($('<div id="prezi-dlg"></div>').css({'display': 'none', 'text-align': 'center'}));
	$('#prezi-dlg').dialog({
			autoOpen: false,
			title: 'Presentation',
			draggable: false,
			modal: true,
			resizable: false,
			width: 700,
			height: 540,
			close: function() {
				$('#prezi-dlg').empty();
			}
		}
	);
	$('body').on('click', 'a[data-popup-handler=prezi]', function(event) {
		var myregexp = /^http\:\/\/prezi\.com\/([^\/]+)\/.+$/ig;
		var match = myregexp.exec(this.href);
		if (match != null) {
			$('#prezi-dlg').append('<iframe src="http://prezi.com/embed/' + match[1] + '/" width="560px" height="345px" scrolling="no" marginwidth="0" marginheight="0"></iframe>');
			$('#prezi-dlg').dialog('open');

		}
		return false;
	});

	// Apply focus properly when accessing internal links with keyboard in WebKit browsers.
	$("a[anchor^='#']").not("a[anchor='#']").click(function() {
		$($(this).attr('anchor')).focus();
	});

	$(".js-filters-skip-link").on('click', function(e){
		e.preventDefault();
		$($(this).attr('href') + " a").not( "[tabindex='-1']" ).not( "[aria-hidden='true']" ).first().focus().scrollIntoView({
			behavior: "smooth", // or "auto" or "instant"
			block: "start" // or "end"
		});;
	})

	function toggleFilters(target){
		target.find('.all-tags').slideToggle('fast');
		target.find('.selected-tags').toggle();
		target.toggleClass('expanded collapsed');
		if (!target.hasClass('v2-style')) {
			target.find('.refine-filter').toggleClass('iconafter-angle-up button')
		}
	}

	var filter = $('.filter-nav');
	filter.on('click', '.refine-filter, .more-tags, .collapse', function(event) {
		toggleFilters($(event.delegateTarget));
		return false;
	});
	filter.on('change', '.tag-input', function(event) {
		var target = $(event.delegateTarget);
		target.find('input[value="' + this.value + '"][name="' + this.name + '"]').prop('checked', this.checked);
		has_selected_tags = Boolean(target.find('.all-tags input[type=checkbox]:checked').length);
		target.find('.nav').toggleClass('has-selected-tags', has_selected_tags);

		if (target.hasClass('collapsed')) {
			toggleFilters(target);
		}

		target.find('.actions input[type=submit]').prop('disabled', false);

	});

	// Hamburger menu visibility
	function debounce(func){
		var timer;
		return function(event){
		  if(timer) clearTimeout(timer);
		  timer = setTimeout(func,100,event);
		};
	}
	function hamburger_menu_visibility() {
		var menu = $('.standard-nav')[0]
		var menu_top = menu.getBoundingClientRect().top + document.documentElement.scrollTop
		var has_overflow = false
		var first_overflow_item = null
		$('.standard-nav > .menu > .menu-item:not(.mobile)').show().each(function(){
			var menu_item = $(this)[0];
			var menu_item_top = menu_item.getBoundingClientRect().top + document.documentElement.scrollTop
			// if menu item overflowing
			if (menu_item_top >= menu_top + menu_item.clientHeight || first_overflow_item !== null) {
					$(this).hide();
					if (first_overflow_item === null) first_overflow_item = $(this)
					has_overflow = true
			}
		})
		if (has_overflow === false) {
			$('.js-hamburger-menu').attr('style', 'display: none !important')
			$('.standard-nav').removeClass('has_hamburger_menu')
		} else {
			$('.js-hamburger-menu').insertBefore(first_overflow_item).attr('style', 'display: block !important') 
			$('.standard-nav').addClass('has_hamburger_menu')
		}
	}

	$(window).on("load", function() {
		hamburger_menu_visibility();
	});

	$(window).resize(function() {
		// close hamburger menu on screen resize 
		if ($('.standard-nav.has_hamburger_menu').hasClass('expanded')) {
			$('.js-hamburger-menu').click();
		}
		debounce(hamburger_menu_visibility())
	})


	$('.js-hamburger-menu').click(function() {
		$(this).parents('.standard-nav').toggleClass('expanded');
		$(this).find('.icon-menu').toggleClass('icon-close');
		if (!$(this).parents('.standard-nav').hasClass('expanded')) {
			$('.js-hamburger-menu').attr('aria-expanded', "false")
			$('.standard-nav .menu-item-has-children').removeClass('focus-within').removeClass('expanded').find('a, .standard-nav-item-expand-button').attr('aria-expanded', "false");
			hamburger_menu_visibility()
		} else {
			$('.standard-nav > .menu > .menu-item:not(.mobile)').show()
			$('.js-hamburger-menu').attr('aria-expanded', "true").insertBefore($('.standard-nav > .menu > .menu-item:not(.mobile)').first()) 
			
			
		}
	});

	$("*").focus(function(e){
		if (! $(e.target).parents(".standard-nav *").length) {
			if ($('.standard-nav').hasClass('expanded')) {
				$('.js-hamburger-menu')[0].click();
			}
			$('.standard-nav .menu-item.focus-within').removeClass('focus-within').removeClass('expanded').find('a, .standard-nav-item-expand-button').attr('aria-expanded', "false");
		}
	})

	$('.menu-item > a').on('focus', function(event) {
		if(!$(this).parent('.focus-within').length) {
			$(this).parent().siblings('.focus-within').removeClass('focus-within').removeClass('expanded').find('a, .standard-nav-item-expand-button').attr('aria-expanded', "false");
		}
	})
	
	// .standard-nav > .menu > .menu-item-has-children:not(.menu-item-has-expand-button) > a   ------- standard nav main menu items without link
	//.standard-nav > .menu > .sub-panel >.sub-menu > ul > .menu-item-has-children > a   ------ only parent elements of submenus with sub panel style
	//.standard-nav-item-expand-button    ----- standard nav menu item with links (has separate arrow button)
	$('.standard-nav > .menu > .menu-item-has-children:not(.menu-item-has-expand-button) > a, .standard-nav > .menu > .sub-panel >.sub-menu > ul > .menu-item-has-children > a, .standard-nav-item-expand-button').on("click",  function(event){
			if (!$(this).parent().hasClass("focus-within")) {
				if ($('.standard-nav').hasClass('has_hamburger_menu') && !$('.standard-nav').hasClass('expanded')){
						$('.js-hamburger-menu')[0].click();
				}
				$(this).parent().addClass('focus-within').addClass('expanded');
				$(this).attr('aria-expanded', "true");
			} else {
				$(this).parent().removeClass('focus-within').removeClass('expanded');
				$(this).attr('aria-expanded', "false");
			}
			// only if it's clicked by keyboard
			if( !(event.screenX && event.screenY) || $(this).attr('href') == '#!'){
				event.preventDefault();
			}
	});

	//Set the sizing for sub-panel menu style
	$('.standard-nav .wide-submenu.sub-panel').each(function() {
		//Change display/visibility so we can get the actual size of items
		$(this).find('>.sub-menu').css({visibility: 'hidden', display: 'block'});
		$(this).find('>.sub-menu>ul>li.menu-item-has-children>.sub-menu').css({display: 'block'});

		var width = Math.max.apply(Math, $(this).find('>.sub-menu>ul>li>a').map(function() {
			return $(this).outerWidth();
		}).get());
		width += 10;

		var height = Math.max.apply(Math, $(this).find('>.sub-menu>ul>li.menu-item-has-children>.sub-menu>ul').map(function() {
			return $(this).outerHeight();
		}).get());
		height += 50;


		$("<style>@media screen and (min-width: 1221px) {\
			.standard-nav ul.menu>li#" + this.id + ">.sub-menu>ul>li { width: " + width + "px; }\
			.standard-nav ul.menu>li#" + this.id + ">.sub-menu>ul>li.menu-item-has-children>.sub-menu { left: " + width + "px; }\
			.standard-nav ul.menu>li#" + this.id + ">.sub-menu{min-height: " + height + "px;}\
			.standard-nav ul.menu>li#" + this.id + ">.sub-menu>ul{min-height: " + height + "px;}\
			}</style>").appendTo('head');

		//Reset display/visibility
		$(this).find('>.sub-menu').css({visibility: '', display: ''});
		$(this).find('>.sub-menu>ul>li.menu-item-has-children>.sub-menu').css({display: ''});
		$(this).addClass('initialized')
	});


	$('.widget_resourceslinkswidget').on('click', '.link-category.expandable .expand-button', function () {
        link_category = $(this).parent();
        $(link_category).toggleClass('expanded');
        if ($(link_category).hasClass('expanded')){
            $(link_category).find('.expandable-area').slideDown();
			$(link_category).find('.expand-button').text($(this).text().replace("Show more", "Show less")).attr('aria-expanded', true)
        } else {
            $(link_category).find('.expandable-area').slideUp();
			$(link_category).find('.expand-button').text($(this).text().replace("Show less", "Show more")).attr('aria-expanded', false)
        }
    });

    if ($('.standard-nav > ul > li.current-menu-item').length)
        $('.standard-nav > ul > li').removeClass('current-menu-parent');


    $('body').on('click', '[data-action="clipboard"]', function(){
        var menu = $(this);
        copyToClipboard(this);
        menu.html('URL copied').addClass('highlight');
        setTimeout(
            function()
            {
				menu.html('<button class="button-link">Copy Link</button>').removeClass('highlight');
				menu.parent().hide();
				setTimeout(
					function () {
						menu.parent().attr('style', '');
					}, 500
				)
			}, 1000
        )
    })

    if ($(".post-carousel .posting-wrapper .post").length > 3 && jQuery(window).width() > 980){
        $(".post-carousel .posting-wrapper").addClass('owl-carousel');
        $(".post-carousel .posting-wrapper").owlCarousel(
            {
                nav: true,
				navElement: 'div',
                navText: ['', ''],
                navClass: [ 'icon-angle-left', 'icon-angle-right' ],
                // items: 3,
                margin: 40,
                responsiveClass:true,
                responsive:{
                    0:{
                        items:1,
                    },
                    980:{
                        items:2,
                    },
                    1220:{
                        items:3,
                    }
                }
            }
        );
    }

	$('.owl-carousel').each(function() {
		//Find each set of dots in this carousel
	  $(this).find('.owl-dot').each(function(index) {
		var title = '';
		var title_element = $(this).parents('.widget-wrapper').find('.widget-title');
		if (title_element.length) {
			title += (title_element.text() + " ");
		}
		//Add one to index so it starts from 1
		$(this).attr('aria-label', title + 'Page ' + (index + 1));
	  });
	});

	//Open all external links in new tab unless a target is specifically set
    $("a").each(function(e){
		if (!this.getAttribute('target') && this.hostname.length > 0 && this.hostname !== window.location.host && this.hostname.indexOf("uconnectlabs.com") === -1) {
            $(this).attr('target', '_blank');
        }
    });

    $('.password-toggle').on('click', function(){
        $target = $('#' + $(this).attr('for') );
		if ($target.attr('type') === 'password') {
            $target.attr('type', 'text');
            $(this).addClass('text');
        } else {
            $target.attr('type', 'password');
            $(this).removeClass('text');
        }
    });

	if( window.location.hash ) {
		var hash = window.location.hash.substring(1); //removes the # character

		if ( hash === 'scroll-to-posts' ){
			setTimeout( function(){
				$('html, body').animate({
					scrollTop: $("#posting-wrapper").offset().top - 100
				}, 300);

			}, 100 );
		}
	}

	//Initialize masonry for .flex-tiles, individual items must use .post-wrapper
	$('.flex-tiles').each(function(){
		var items = $(this);
		items.imagesLoaded(function(){
			items.masonry({
				fitWidth: false,
				itemSelector: '.post-wrapper',
				columnWidth: '.post-wrapper',
				gutter: 0,
				percentPosition: true,
				originLeft: true
			});
		});

	})

	$('.fittext').each(function(){
		var options = {};
		//Fittext options can be set as a JSON string on data-fittext attribute
		if ( $(this).data('fittext') ){
			options = $(this).data('fittext');
		}
		textFit(this, options);
	})


	//Remove menu items with anchor links that their item is not on current page
	$('.hero-nav li.anchor-link a').each(function () {
		if ( $(this).attr('href') !== '#!' && !$($(this).attr('href')).length) {
			$(this).parent().remove();
		}
	})
	$('.hero-nav').addClass('initialized');

	/**
	 * Remove anchor links that their target item is not on the current page
	 */
	$('a.anchor-link').each(function () {
		if (!$($(this).attr('href')).length) {
			$(this).remove();
		}
	});


	//Handles vertical tabs in content. This requires two adjacent UL elements, one for the tabs and one for the content
	//of each tab. Only the first UL needs to have `vertical-tabs` as the class
	$('ul.vertical-tabs').each(function () {
		$('<div class="vertical-tabs-wrapper"></div>').insertBefore(this).prepend($(this).find('+ul')).prepend($(this)).append('<div class="clearfix"></div>');
	}).on('click', '>li', function () {
		$('ul.vertical-tabs > li').removeClass('active').addClass('deactive');
		$(this).addClass('active').removeClass('deactive');

		$(this).parent().find('+ul > li').removeClass('active').addClass('deactive');
		$(this).parent().find('+ul > li').eq($(this).index()).addClass('active').removeClass('deactive');
	})


	// Sticky header
	var wpAdminBar = $("#wpadminbar");
	var header = $("#header");
	var top_ribbon = $("#top_ribbon");
	var nav = $("#access .standard-nav");
	var hero_nav = $(".hero-nav").first();
	var nav_top = nav.offset().top
	var top_ribbon_top = top_ribbon.offset().top
	var hero_nav_sticky = $('[id^="menu-"][id$="-sticky"]')
	var header_top = header.offset().top
	var hero_nav_top = 0
	if (hero_nav.length) {
		hero_nav_top = hero_nav.offset().top
	}

	var offset = 0;
	if (wpAdminBar.length) {
		offset += wpAdminBar.outerHeight()
	}
	var nav_offset = 0;
	var hero_nav_offset = offset;
	var scroll_offset = offset;


	// fix scroll offset when clicked on anchor link
	if (stickyHeader.indexOf("header") != -1) {
		scroll_offset = offset + header.outerHeight();
	} else {
		if (stickyHeader.indexOf("ribbon") != -1) {
			scroll_offset = offset + top_ribbon.outerHeight();
		}
		if (stickyHeader.indexOf("nav") != -1) {
			scroll_offset = offset + top_ribbon.outerHeight() + nav.outerHeight();
		}

	}
	if (hero_nav.length && (stickyHeader.indexOf("hero") != -1 || hero_nav_sticky.length)) {
		scroll_offset += hero_nav.outerHeight()
	}
	if ( scroll_offset ) {
		$('html, body').css('scroll-padding-top', `${scroll_offset}px`);
	}

	$(window).on("scroll", function (e) {
		if (stickyHeader.indexOf("header") != -1) {
			hero_nav_offset = offset + header.outerHeight();
			if ($(window).scrollTop() > header_top - offset) {
				if (!header.hasClass('header--sticky')) {
					header.addClass("header--sticky");
					$( '<div id="headerPlaceholder" style="height:' + header.outerHeight() + 'px;"></div>' ).insertBefore( header );
				}
			} else {
				header.removeClass("header--sticky");
				$('#headerPlaceholder').remove();
			}
		} else {
			if (stickyHeader.indexOf("ribbon") != -1) {
				hero_nav_offset = offset + top_ribbon.outerHeight();
				nav_offset = top_ribbon.outerHeight();
				if ($(window).scrollTop() > top_ribbon_top - offset) {
					if (!header.hasClass('topRibbon--sticky')) {
						header.addClass("topRibbon--sticky");
						$( '<div id="ribbonPlaceholder" style="height:' + top_ribbon.outerHeight() + 'px;"></div>' ).insertBefore( top_ribbon );
					}
				} else {
					nav_offset = 0;
					hero_nav_offset = offset;
					header.removeClass("topRibbon--sticky");
					$('#ribbonPlaceholder').remove();
				}
			}
			if (stickyHeader.indexOf("nav") != -1) {
				if ($(window).scrollTop() > nav_top - offset - nav_offset) {
					hero_nav_offset = offset + nav_offset + nav.outerHeight();
					header.addClass("nav--sticky");
				} else {
					hero_nav_offset = offset + nav_offset;
					header.removeClass("nav--sticky");
				}
			}

		}

		if (hero_nav.length && (stickyHeader.indexOf("hero") != -1 || hero_nav_sticky.length)) {
			if ($(window).scrollTop() > hero_nav_top - hero_nav_offset ) {
				if (!hero_nav.hasClass('heroNav--sticky')) {
					hero_nav.addClass("heroNav--sticky");
					hero_nav.css('top', hero_nav_offset);
					$( '<div id="heroNavPlaceholder" style="height:' + hero_nav.outerHeight() + 'px;"></div>' ).insertBefore( hero_nav );
				}
			} else {
				hero_nav.removeClass("heroNav--sticky");
				hero_nav.css('top', 0);
				$('#heroNavPlaceholder').remove();
			}
		}

	});

});


document.addEventListener("DOMContentLoaded", function() {
	const first_full_image = document.querySelector('.entry-content *:first-child.wp-block-image.alignfull');
	if (first_full_image !== null) {
		let root = document.documentElement;
		root.style.setProperty('--firstCoverHeight', first_full_image.clientHeight + 'px' );
		window.addEventListener('resize', () => {
			root.style.setProperty('--firstCoverHeight', first_full_image.clientHeight + 'px' );
		});
	}
});
